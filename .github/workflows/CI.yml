name: CI # Check Gradle and AGP combinations
on: push
jobs:
  check:
    name: 2 ðŸ› ï¸ ${{ matrix.name }}
    runs-on: ubuntu-22.04
    env:
      JOB_NAME: ${{ matrix.name }} (${{ matrix.agp }} on ${{ matrix.gradle }})
    timeout-minutes: 12
    steps:
      - name: Set up JDK(s).
        run: |
          echo "JAVA8_HOME=$JAVA_HOME_8_X64" | tee --append $GITHUB_ENV
          echo "JAVA11_HOME=$JAVA_HOME_11_X64" | tee --append $GITHUB_ENV
          echo "JAVA_HOME=$JAVA_HOME_11_X64" | tee --append $GITHUB_ENV

      - name: Checkout ${{ github.ref }} branch in ${{ github.repository }} repository.
        uses: actions/checkout@v3

      - name: Download Gradle ${{ matrix.gradle }} running the tests.
        run: |
          # Create an empty project with wrapper using ${{ matrix.gradle }}.
          mkdir ~/gradle-${{ matrix.gradle }}
          cd ~/gradle-${{ matrix.gradle }}
          touch settings.gradle
          ${{ github.workspace }}/gradlew wrapper --gradle-version ${{ matrix.gradle }} --distribution-type all --quiet
          # Run a no-op gradlew command in an empty project with a specific wrapper version.
          ./gradlew --no-daemon --version

      - name: Check ${{ env.JOB_NAME }}.
        run: >
          ./gradlew
          --no-daemon
          --no-build-cache
          --no-configuration-cache
          --no-watch-fs
          --stacktrace
          --continue
          ${{ matrix.test-task }}
          -Pnet.twisterrob.gradle.build.verboseReports=true
          -Pnet.twisterrob.test.android.pluginVersion=${{ matrix.agp }}
          -Pnet.twisterrob.test.kotlin.pluginVersion=${{ matrix.kotlin }}
          -Pnet.twisterrob.gradle.runner.gradleVersion=${{ matrix.gradle }}
          -Pnet.twisterrob.test.gradle.javaHomeEnv=JAVA_HOME_11_X64

      - name: Upload "${{ env.JOB_NAME }} Test Results XMLs" artifact.
        if: success() || failure()
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.JOB_NAME }} Test Results XMLs
          path: ${{ github.workspace }}/**/build/test-results/test/TEST-*.xml

      - name: Upload "${{ env.JOB_NAME }} Test Results HTML" artifact.
        if: success() || failure()
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.JOB_NAME }} Test Results HTML
          path: ${{ github.workspace }}/build/reports/tests/all/

      - name: Upload "${{ env.JOB_NAME }} Test Results HTMLs" artifact.
        if: success() || failure()
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.JOB_NAME }} Test Results HTMLs
          path: ${{ github.workspace }}/**/build/reports/tests/test/

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "AGP 7.4.x on Gradle 7.5+ - plugin"
            gradle: 7.5.1
            agp: 7.4.1
            kotlin: 1.6.21
            build-tools: 32.0.0
            instant-api: 30
            test-task: testReport :plugin:signing:test --info
          - name: "AGP 7.4.x on Gradle 7.x - plugin"
            gradle: 7.6
            agp: 7.4.1
            kotlin: 1.6.21
            build-tools: 32.0.0
            instant-api: 30
            test-task: testReport :plugin:signing:test --info
          - name: "AGP 7.4.x on Gradle 8.x - plugin"
            gradle: 8.0-rc-5
            agp: 7.4.1
            kotlin: 1.6.21
            build-tools: 32.0.0
            instant-api: 30
            test-task: testReport :plugin:signing:test --info

  publish-test-results:
    name: 3 ðŸ“¢ Publish Tests Results
    runs-on: ubuntu-22.04
    needs: check
    if: success() || failure()
    timeout-minutes: 10

    steps:
      - name: Download 'AGP 7.4.x on Gradle 7.5+ - plugin (7.4.1 on 7.5.1) Test Results XMLs' artifact.
        if: success() || failure()
        uses: actions/download-artifact@v3
        with:
          name: AGP 7.4.x on Gradle 7.5+ - plugin (7.4.1 on 7.5.1) Test Results XMLs
          path: artifacts/AGP 7.4.x on Gradle 7.5+ - plugin (7.4.1 on 7.5.1) Test Results XMLs

      - name: Download 'AGP 7.4.x on Gradle 7.x - plugin (7.4.1 on 7.6) Test Results XMLs' artifact.
        if: success() || failure()
        uses: actions/download-artifact@v3
        with:
          name: AGP 7.4.x on Gradle 7.x - plugin (7.4.1 on 7.6) Test Results XMLs
          path: artifacts/AGP 7.4.x on Gradle 7.x - plugin (7.4.1 on 7.6) Test Results XMLs

      - name: Download 'AGP 7.4.x on Gradle 8.x - plugin (7.4.1 on 8.0-rc-5) Test Results XMLs' artifact.
        if: success() || failure()
        uses: actions/download-artifact@v3
        with:
          name: AGP 7.4.x on Gradle 8.x - plugin (7.4.1 on 8.0-rc-5) Test Results XMLs
          path: artifacts/AGP 7.4.x on Gradle 8.x - plugin (7.4.1 on 8.0-rc-5) Test Results XMLs

      - name: Publish "Test Results" check suite.
        if: success() || failure()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          check_name: 0 ðŸ”” Test Results
          comment_mode: off
          report_individual_runs: true
          test_changes_limit: 0
          junit_files: artifacts/* Test Results XMLs/**/*.xml
